<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Causal Compiler v3.4 - Mobile Responsive</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d1117; --card-bg: #161b22; --text: #c9d1d9; --accent: #58a6ff; --border: #30363d; --success: #238636; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; line-height: 1.4; }
        .container { width: 100%; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        .header h1 { font-family: 'Fira Code', monospace; color: var(--accent); font-size: 1.2rem; text-align: center; margin: 10px 0; }
        .api-section { background: var(--card-bg); padding: 8px; border-radius: 8px; border: 1px solid var(--border); }
        input, textarea { background: #010409 !important; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; width: 100%; font-size: 15px; outline: none; }
        .field-container { position: relative; background: var(--card-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
        .label { display: block; margin-bottom: 6px; font-family: 'Fira Code', monospace; font-size: 0.75rem; color: var(--accent); text-align: right; }
        textarea { min-height: 100px; text-align: left; direction: ltr; resize: none; }
        .btn-copy { position: absolute; top: 8px; left: 8px; background: #21262d; border: 1px solid var(--border); color: var(--accent); cursor: pointer; padding: 5px 10px; border-radius: 4px; font-size: 0.65rem; z-index: 5; }
        .btn-generate { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; width: 100%; transition: 0.2s; margin: 5px 0; }
        #anatomy-output { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; direction: ltr; }
        .word-bubble { background: #21262d; border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; cursor: help; font-family: 'Fira Code', monospace; font-size: 0.85rem; position: relative; }
        .tree-modal { display: none; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #30363d; padding: 10px; border-radius: 8px; width: 220px; z-index: 100; border: 1px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .word-bubble:active .tree-modal, .word-bubble:hover .tree-modal { display: block; }
        .tree-item { font-size: 0.7rem; border-bottom: 1px solid #484f58; padding: 4px 0; color: #e6edf3; text-align: left; }
        .tree-item b { color: var(--accent); }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h1>CAUSAL COMPILER v3.4</h1></div>
    <div class="api-section"><input type="password" id="apiKey" placeholder="Gemini API Key..."></div>
    
    <div class="field-container">
        <label class="label">Step 1: Input</label>
        <button class="btn-copy" onclick="copyVal('inputRaw')">COPY</button>
        <textarea id="inputRaw" placeholder="Enter text here..."></textarea>
    </div>

    <button class="btn-generate" onclick="processTranslation()" id="generateBtn">COMPILE & ANALYZE</button>

    <div class="field-container">
        <label class="label">Step 2: Corrected English</label>
        <button class="btn-copy" onclick="copyVal('outputEnglish')">COPY</button>
        <textarea id="outputEnglish" readonly></textarea>
    </div>

    <div class="field-container">
        <label class="label">Step 3: Causal Language (Responsive Anatomy)</label>
        <button class="btn-copy" onclick="copyVal('outputCausalText')">COPY</button>
        <textarea id="outputCausalText" style="display:none;"></textarea>
        <div id="anatomy-output"></div>
    </div>
</div>

<script>
    function copyVal(id) {
        const val = document.getElementById(id).value;
        navigator.clipboard.writeText(val);
        alert('Copied!');
    }

    async function processTranslation() {
        const apiKey = document.getElementById('apiKey').value;
        const input = document.getElementById('inputRaw').value;
        const btn = document.getElementById('generateBtn');
        if (!apiKey || !input) return alert('Key/Input needed.');
        btn.disabled = true; btn.innerText = "ENGINEERING...";

        const systemPrompt = `As a professional grammar character, correct my English/Persian multilingual input to simplified and clarified English. DO NOT change simple sentences like "I can not do this" into complex ones like "I am unable". Keep it lean.
        
        Then translate to Causal Language using these strict laws:
        1. NEGATIVE: Use 'no' after modal verbs (e.g., Potis no). [cite: 2026-02-21]
        2. DO: Root is 'fac'. Do=facis, Does=faclis, Did=factis. [cite: 2026-02-20]
        3. HAVE: Always 'havis'. [cite: 2026-02-21]
        4. MODALS: Can=Potis, Must=Debis, Want=Volis. (No 'te' after). [cite: 2026-02-21]
        5. VERBS: Present '-is', Past '-t-is', Future 'bolis' + root. [cite: 2026-02-20]
        6. NOUNS: Semantic Derivation (Combine 2 Latin roots + Erode). [cite: 2026-02-20]
        7. MARKERS: Object '-o', Plural 'z', The 'le-'. [cite: 2026-02-21]
        
        Return JSON: { "refined_english": "...", "causal_language": "...", "anatomy_tree": { "word": ["Meaning: ...", "Roots: ...", "Role: ..."] } }`;

        try {
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nInput: " + input }] }] })
            });
            const data = await response.json();
            const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
            document.getElementById('outputEnglish').value = result.refined_english;
            document.getElementById('outputCausalText').value = result.causal_language;
            
            const container = document.getElementById('anatomy-output');
            container.innerHTML = '';
            result.causal_language.split(' ').forEach(word => {
                const clean = word.replace(/[.,!?;]/g, '');
                const bubble = document.createElement('div');
                bubble.className = 'word-bubble'; bubble.innerText = word;
                const modal = document.createElement('div');
                modal.className = 'tree-modal';
                (result.anatomy_tree[clean] || ["Logical Marker"]).forEach(d => {
                    const item = document.createElement('div');
                    item.className = 'tree-item';
                    item.innerHTML = d.replace(/([^:]+):/, "<b>$1:</b>");
                    modal.appendChild(item);
                });
                bubble.appendChild(modal); container.appendChild(bubble);
            });
        } catch (e) { alert('Error. Check Key.'); }
        finally { btn.disabled = false; btn.innerText = "COMPILE & ANALYZE"; }
    }
</script>
</body>
</html>
