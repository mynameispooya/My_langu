<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Causal Compiler v4.6 - Gemini 2.5 Flash</title>

<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root { --bg:#0d1117; --card-bg:#161b22; --text:#c9d1d9; --accent:#58a6ff; --border:#30363d; --success:#238636; }
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); margin:0; padding:10px; }
.container { max-width:800px; margin:auto; display:flex; flex-direction:column; gap:12px; }
.header h1 { font-family:'Fira Code',monospace; color:var(--accent); text-align:center; font-size:1.2rem; }

.api-section { background:var(--card-bg); padding:8px; border-radius:8px; border:1px solid var(--border); }

input, textarea {
background:#010409!important;
border:1px solid var(--border);
color:#fff;
padding:10px;
border-radius:6px;
width:100%;
font-size:15px;
outline:none;
}

.field-container {
position:relative;
background:var(--card-bg);
padding:12px;
border-radius:12px;
border:1px solid var(--border);
}

.label {
display:block;
margin-bottom:6px;
font-family:'Fira Code',monospace;
font-size:0.75rem;
color:var(--accent);
text-align:right;
}

textarea { min-height:80px; direction:ltr; resize:none; }

.btn-copy {
position:absolute;
top:8px;
left:8px;
background:#21262d;
border:1px solid var(--border);
color:var(--accent);
cursor:pointer;
padding:5px 10px;
border-radius:4px;
font-size:0.65rem;
}

.btn-generate {
background:var(--success);
color:white;
border:none;
padding:15px;
border-radius:8px;
cursor:pointer;
font-weight:600;
font-size:1rem;
width:100%;
}

#anatomy-output {
display:flex;
flex-wrap:wrap;
gap:8px;
direction:ltr;
min-height:50px;
}

/* Marker Colors */
.m-verb { color:#ff4d4d; font-weight:bold; }
.m-inf  { color:#ffa500; font-weight:bold; }
.m-adv  { color:#ff69b4; font-weight:bold; }
.m-past { color:#bf00ff; font-weight:bold; }
.m-3rd  { color:#00ff00; font-weight:bold; }
.m-ing  { color:#00bfff; font-weight:bold; }
.m-pp   { color:#ffff00; font-weight:bold; }

.word-bubble {
background:#21262d;
border:1px solid var(--border);
padding:8px 14px;
border-radius:10px;
font-family:'Fira Code',monospace;
position:relative;
color:#fff;
}

.tree-modal {
display:none;
position:absolute;
bottom:120%;
left:50%;
transform:translateX(-50%);
background:#30363d;
padding:12px;
border-radius:8px;
width:260px;
border:1px solid var(--accent);
pointer-events:none;
}

.word-bubble:hover .tree-modal { display:block; }

.tree-item {
font-size:0.75rem;
border-bottom:1px solid #484f58;
padding:5px 0;
}

.tree-item:last-child { border-bottom:none; }
</style>
</head>

<body>
<div class="container">

<div class="header"><h1>CAUSAL COMPILER v4.6</h1></div>

<div class="api-section">
<input type="password" id="apiKey" placeholder="Gemini API Key...">
</div>

<div class="field-container">
<label class="label">Step 1: Input (English)</label>
<button class="btn-copy" onclick="copyById('inputRaw')">COPY</button>
<textarea id="inputRaw" placeholder="Enter English sentence..."></textarea>
</div>

<button class="btn-generate" onclick="processTranslation()" id="generateBtn">
EXECUTE STABLE COMPILATION
</button>

<div class="field-container">
<label class="label">Step 2: Polished English</label>
<button class="btn-copy" onclick="copyById('outputEnglish')">COPY</button>
<textarea id="outputEnglish" readonly></textarea>
</div>

<div class="field-container">
<label class="label">Step 3: Causal Language</label>
<button class="btn-copy" onclick="copyBubbles()">COPY</button>
<div id="anatomy-output"></div>
</div>

</div>

<script>

function copyById(id){
navigator.clipboard.writeText(document.getElementById(id).value);
alert("Copied!");
}

function copyBubbles(){
const text = Array.from(document.querySelectorAll('.word-bubble'))
.map(b=>b.innerText).join(' ');
navigator.clipboard.writeText(text);
alert("Causal Text Copied!");
}

function highlightAnatomy(word){
return word
.replace(/([a-zA-Z]+)(r)(is)/g,'$1<span class="m-3rd">$2</span><span class="m-verb">$3</span>')
.replace(/([a-zA-Z]+)(t)(is)/g,'$1<span class="m-past">$2</span><span class="m-verb">$3</span>')
.replace(/([a-zA-Z]+)(is)\b/g,'$1<span class="m-verb">$2</span>')
.replace(/([a-zA-Z]+)(er)\b/g,'$1<span class="m-inf">$2</span>')
.replace(/([a-zA-Z]+)(im)\b/g,'$1<span class="m-adv">$2</span>')
.replace(/([a-zA-Z]+)(an)\b/g,'$1<span class="m-ing">$2</span>')
.replace(/([a-zA-Z]+)(at)\b/g,'$1<span class="m-pp">$2</span>');
}

async function processTranslation(){

const apiKey = document.getElementById('apiKey').value.trim();
const input = document.getElementById('inputRaw').value.trim();
const btn = document.getElementById('generateBtn');

if(!apiKey || !input){
alert("Please enter API Key and Input text.");
return;
}

btn.disabled=true;
btn.innerText="Processing...";

try{

const response = await fetch(
'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key='+apiKey,
{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
contents:[{parts:[{text:input}]}]
})
}
);

const data = await response.json();

if(!response.ok){
throw new Error(data.error?.message || "API request failed");
}

if(
!data ||
!data.candidates ||
!Array.isArray(data.candidates) ||
data.candidates.length===0 ||
!data.candidates[0].content ||
!data.candidates[0].content.parts ||
!data.candidates[0].content.parts[0] ||
!data.candidates[0].content.parts[0].text
){
throw new Error("Model returned invalid structure");
}

const rawText = data.candidates[0].content.parts[0].text;

let parsed;

try{
parsed = JSON.parse(rawText);
}catch{
const match = rawText.match(/\{[\s\S]*\}/);
if(!match) throw new Error("No valid JSON found in model output");
parsed = JSON.parse(match[0]);
}

if(!parsed.refined_english || !parsed.causal_language){
throw new Error("Missing required fields in JSON");
}

document.getElementById('outputEnglish').value = parsed.refined_english;

const container = document.getElementById('anatomy-output');
container.innerHTML='';

const tree = parsed.anatomy_tree || {};

parsed.causal_language.split(/\s+/).forEach(word=>{
if(!word) return;

const cleanKey = word.replace(/[.,!?;]/g,'');

const bubble=document.createElement('div');
bubble.className='word-bubble';
bubble.innerHTML=highlightAnatomy(word);

const modal=document.createElement('div');
modal.className='tree-modal';

const info = tree[cleanKey] || ["Anatomically Valid Unit"];

info.forEach(d=>{
const item=document.createElement('div');
item.className='tree-item';
item.innerHTML=String(d).replace(/([^:]+):/,"<b>$1:</b>");
modal.appendChild(item);
});

bubble.appendChild(modal);
container.appendChild(bubble);
});

}catch(e){
console.error(e);
alert("Anatomical Error:\n"+e.message);
}

btn.disabled=false;
btn.innerText="EXECUTE STABLE COMPILATION";
}

</script>

</body>
</html>
