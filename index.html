<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Causal Compiler v4.7 - Stable Core</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root { --bg:#0d1117; --card-bg:#161b22; --text:#c9d1d9; --accent:#58a6ff; --border:#30363d; --success:#238636;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:10px}
.container{max-width:800px;margin:auto;display:flex;flex-direction:column;gap:12px}
.header h1{font-family:'Fira Code',monospace;color:var(--accent);text-align:center}
input,textarea{background:#010409;border:1px solid var(--border);color:#fff;padding:10px;border-radius:6px;width:100%}
textarea{min-height:90px;direction:ltr}
.field-container{background:var(--card-bg);padding:12px;border-radius:12px;border:1px solid var(--border);position:relative}
.label{font-family:'Fira Code',monospace;font-size:.75rem;color:var(--accent)}
.btn-generate{background:var(--success);color:#fff;border:none;padding:15px;border-radius:8px;cursor:pointer}
.word-bubble{background:#21262d;border:1px solid var(--border);padding:8px 14px;border-radius:10px;font-family:'Fira Code';position:relative}
.tree-modal{display:none;position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:#30363d;padding:10px;border-radius:8px;width:260px;border:1px solid var(--accent)}
.word-bubble:hover .tree-modal{display:block}
.tree-item{font-size:.75rem;border-bottom:1px solid #484f58;padding:4px 0}
</style>
</head>

<body>
<div class="container">
<div class="header"><h1>CAUSAL COMPILER v4.7</h1></div>

<input type="password" id="apiKey" placeholder="Gemini API Key...">

<div class="field-container">
<label class="label">Step 1: Input (English)</label>
<textarea id="inputRaw"></textarea>
</div>

<button class="btn-generate" onclick="processTranslation()" id="generateBtn">
EXECUTE STABLE COMPILATION
</button>

<div class="field-container">
<label class="label">Step 2: Polished English</label>
<textarea id="outputEnglish" readonly></textarea>
</div>

<div class="field-container">
<label class="label">Step 3: Causal Language</label>
<div id="anatomy-output" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
</div>

</div>

<script>
async function processTranslation(){

const apiKey = document.getElementById('apiKey').value.trim();
const input = document.getElementById('inputRaw').value.trim();
const btn = document.getElementById('generateBtn');

if(!apiKey || !input) return alert("Enter API Key & text.");

btn.disabled = true;
btn.innerText = "STABILIZING CORE...";

const systemPrompt = `
You are Causal Compiler v4.7.

STRICT RULES:
- Latin word -> Root -> Erosion into short melodic word.
- PLURAL suffix = z
- HAVE root = Havis
- STRUCTURE must follow exact English anatomy
- VERB=-is
- INFINITIVE=-er
- ADVERB=-im
- 3rd=-r-is
- PAST=-t-is
- ING=-an
- PP=-at
- NO HTML TAGS inside causal_language

Return ONLY VALID JSON:

{
 "refined_english":"...",
 "causal_language":"...",
 "anatomy_tree":{
   "word":["Meaning: ...","Latin: ...","Erosion: ..."]
 }
}

Input: ${input}
`;

try{

const response = await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
contents:[{parts:[{text:systemPrompt}]}],
generationConfig:{
responseMimeType:"application/json",
temperature:0.3
}
})
});

const data = await response.json();

if(data.error){
throw new Error(data.error.message);
}

const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
if(!rawText) throw new Error("Empty model response");

let result;

try{
result = JSON.parse(rawText);
}catch{
const match = rawText.match(/\{[\s\S]*\}/);
if(!match) throw new Error("No JSON found in output");
result = JSON.parse(match[0]);
}

document.getElementById("outputEnglish").value = result.refined_english || "";

const container = document.getElementById("anatomy-output");
container.innerHTML = "";

(result.causal_language || "").split(/\s+/).forEach(word=>{
if(!word) return;
const clean = word.replace(/[.,!?;]/g,"");

const bubble = document.createElement("div");
bubble.className = "word-bubble";
bubble.innerText = word;

const modal = document.createElement("div");
modal.className = "tree-modal";

(result.anatomy_tree?.[clean] || ["Anatomically Valid Unit"])
.forEach(info=>{
const item = document.createElement("div");
item.className = "tree-item";
item.innerHTML = info.replace(/([^:]+):/,"<b>$1:</b>");
modal.appendChild(item);
});

bubble.appendChild(modal);
container.appendChild(bubble);
});

}catch(err){
console.error(err);
alert("Anatomical Error:\n"+err.message);
}
finally{
btn.disabled = false;
btn.innerText = "EXECUTE STABLE COMPILATION";
}
}
</script>
</body>
</html>
